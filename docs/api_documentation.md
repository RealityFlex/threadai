# API Документация Threads API

## Основные URL
- Базовый URL: `https://sber.levandrovskiy.ru/`
- Статические файлы/изображения: `https://sber.levandrovskiy.ru/uploads/images/`

## Авторизация
API не требует авторизацию в текущей реализации.

## Endpoint'ы API

### Посты

#### 1. Создание поста
**URL**: `POST /posts/`

**Описание**: Создает новый пост. Можно прикрепить изображение или указать ссылку на медиа.

**Входные данные**:
- `content`: string, обязательный - содержание поста
- `user_id`: integer, обязательный - ID пользователя-автора
- `child_id`: integer, опциональный - ID родительского поста (для комментария)
- `post_type_id`: integer, обязательный - тип поста (1-Пост, 2-Комментарий, 3-Репост)
- `media_link`: string, опциональный - ссылка на медиа-контент
- `image`: file, опциональный - загружаемое изображение

**Ответ (200 OK)**:
```json
{
  "post_id": 123,
  "content": "Текст поста",
  "child_id": null,
  "media_link": "/uploads/images/post_20230726172512_a1b2c3d4e5f6.jpg",
  "post_type_id": 1,
  "user_id": 1,
  "creation_date": "2023-07-26T17:25:12",
  "views_count": 0
}
```

**Ошибки**:
- 400: Некорректные данные
- 500: Серверная ошибка

#### 2. Получение списка постов
**URL**: `GET /posts/`

**Описание**: Возвращает список постов с пагинацией.

**Параметры запроса**:
- `skip`: integer, опциональный (по умолчанию 0) - сколько постов пропустить
- `limit`: integer, опциональный (по умолчанию 100) - максимальное количество возвращаемых постов

**Ответ (200 OK)**:
```json
[
  {
    "post_id": 123,
    "content": "Текст поста",
    "child_id": null,
    "media_link": "/uploads/images/post_20230726172512_a1b2c3d4e5f6.jpg",
    "post_type_id": 1,
    "user_id": 1,
    "creation_date": "2023-07-26T17:25:12",
    "views_count": 0
  },
  // ...другие посты
]
```

#### 3. Получение детальной информации о посте
**URL**: `GET /posts/{post_id}`

**Описание**: Возвращает пост с дополнительной информацией (лайки, теги, комментарии).

**Ответ (200 OK)**:
```json
{
  "post_id": 123,
  "content": "Текст поста",
  "child_id": null,
  "media_link": "/uploads/images/post_20230726172512_a1b2c3d4e5f6.jpg", 
  "post_type_id": 1,
  "user_id": 1,
  "creation_date": "2023-07-26T17:25:12",
  "views_count": 1,
  "likes_count": 5,
  "tags": [
    {"tag_id": 1, "name": "python", "tag_type_id": 1},
    {"tag_id": 2, "name": "fastapi", "tag_type_id": 1}
  ],
  "comments": [
    {
      "post_id": 124,
      "content": "Отличный пост!",
      "child_id": 123,
      "media_link": null,
      "post_type_id": 2,
      "user_id": 2,
      "creation_date": "2023-07-26T18:00:00",
      "views_count": 0,
      "replies": []
    }
  ]
}
```

**Ошибки**:
- 404: Пост не найден

#### 4. Обновление поста
**URL**: `PUT /posts/{post_id}`

**Описание**: Обновляет существующий пост.

**Входные данные**:
- `content`: string, опциональный - новое содержание поста
- `media_link`: string, опциональный - новая ссылка на медиа-контент
- `image`: file, опциональный - новое изображение

**Ответ (200 OK)**:
```json
{
  "post_id": 123,
  "content": "Обновленный текст поста",
  "child_id": null,
  "media_link": "/uploads/images/post_20230726172512_updated_a1b2c3d4e5f6.jpg",
  "post_type_id": 1,
  "user_id": 1,
  "creation_date": "2023-07-26T17:25:12",
  "views_count": 1
}
```

**Ошибки**:
- 404: Пост не найден
- 500: Серверная ошибка

#### 5. Удаление поста
**URL**: `DELETE /posts/{post_id}`

**Описание**: Удаляет пост и все связанные данные (лайки, теги).

**Ответ (204 No Content)**

**Ошибки**:
- 404: Пост не найден

### Комментарии

#### 1. Создание комментария
**URL**: `POST /comments/`

**Описание**: Создает новый комментарий к посту.

**Входные данные**:
- `content`: string, обязательный - содержание комментария
- `user_id`: integer, обязательный - ID пользователя-автора
- `child_id`: integer, обязательный - ID родительского поста 
- `media_link`: string, опциональный - ссылка на медиа-контент
- `image`: file, опциональный - загружаемое изображение

**Ответ (201 Created)**:
```json
{
  "post_id": 124,
  "content": "Текст комментария",
  "child_id": 123,
  "media_link": null,
  "post_type_id": 2,
  "user_id": 1,
  "creation_date": "2023-07-26T18:00:00",
  "views_count": 0
}
```

**Ошибки**:
- 422: Некорректные данные

#### 2. Получение комментариев к посту
**URL**: `GET /posts/{post_id}/comments/`

**Описание**: Возвращает список комментариев к указанному посту.

**Параметры запроса**:
- `skip`: integer, опциональный (по умолчанию 0) - сколько комментариев пропустить
- `limit`: integer, опциональный (по умолчанию 100) - максимальное количество возвращаемых комментариев

**Ответ (200 OK)**:
```json
[
  {
    "post_id": 124,
    "content": "Текст комментария",
    "child_id": 123,
    "media_link": null,
    "post_type_id": 2,
    "user_id": 1,
    "creation_date": "2023-07-26T18:00:00",
    "views_count": 0
  },
  // ...другие комментарии
]
```

### Лайки

#### 1. Поставить лайк
**URL**: `POST /likes/`

**Описание**: Добавляет лайк от пользователя к посту.

**Входные данные (JSON)**:
```json
{
  "post_id": 123,
  "user_id": 1
}
```

**Ответ (201 Created)**:
```json
{
  "like_id": 42,
  "post_id": 123,
  "user_id": 1
}
```

**Ошибки**:
- 422: Некорректные данные

#### 2. Убрать лайк
**URL**: `DELETE /posts/{post_id}/likes/{user_id}`

**Описание**: Удаляет лайк пользователя с указанного поста.

**Ответ (204 No Content)**

**Ошибки**:
- 404: Лайк не найден

### Пользователи

#### 1. Получение рекомендованных постов
**URL**: `GET /users/{user_id}/recommended-posts`

**Описание**: Возвращает список постов, рекомендованных для пользователя.

**Параметры запроса**:
- `skip`: integer, опциональный (по умолчанию 0) - сколько постов пропустить
- `limit`: integer, опциональный (по умолчанию 10) - максимальное количество возвращаемых постов

**Ответ (200 OK)**:
```json
[
  {
    "post_id": 123,
    "content": "Текст поста",
    "child_id": null,
    "media_link": "/uploads/images/post_20230726172512_a1b2c3d4e5f6.jpg",
    "post_type_id": 1,
    "user_id": 1,
    "creation_date": "2023-07-26T17:25:12",
    "views_count": 0
  },
  // ...другие рекомендованные посты
]
```

**Ошибки**:
- 404: Пользователь не найден
- 500: Серверная ошибка

#### 2. Получение тегов пользователя
**URL**: `GET /users/{user_id}/tags`

**Описание**: Возвращает список тегов, соответствующих интересам пользователя.

**Ответ (200 OK)**:
```json
[
  {"tag_id": 1, "name": "python", "tag_type_id": 1},
  {"tag_id": 2, "name": "fastapi", "tag_type_id": 1}
]
```

**Ошибки**:
- 404: Пользователь не найден
- 500: Серверная ошибка

#### 3. Получение подробной информации о пользователе
**URL**: `GET /users/{user_id}`

**Описание**: Возвращает детальную информацию о пользователе.

**Ответ (200 OK)**:
```json
{
  "user_id": 1,
  "login": "user123",
  "name": "Иван Иванов",
  "type_id": 1,
  "profile_type": "Студент",
  "image_link": "/uploads/images/user_profile.jpg",
  "description": "Описание профиля пользователя",
  "rating": 4.8,
  "tags": [
    {"tag_id": 1, "name": "python", "tag_type_id": 1},
    {"tag_id": 2, "name": "fastapi", "tag_type_id": 1}
  ],
  "post_count": 15,
  "likes_count": 42
}
```

**Ошибки**:
- 404: Пользователь не найден
- 500: Серверная ошибка

### Системные эндпоинты

#### 1. Проверка работоспособности API
**URL**: `GET /health`

**Описание**: Проверяет работоспособность API.

**Ответ (200 OK)**:
```json
{
  "status": "ok"
}
```

#### 2. Инициализация базы данных
**URL**: `POST /system/init-db`

**Описание**: Инициализирует базу данных начальными значениями.

**Ответ (200 OK)**:
```json
{
  "status": "success",
  "message": "База данных успешно инициализирована"
}
```

**Ошибки**:
- 500: Ошибка при инициализации

#### 3. Создание тестового пользователя
**URL**: `POST /system/create-test-user`

**Описание**: Создает тестового пользователя.

**Ответ (200 OK)**:
```json
{
  "status": "success",
  "message": "Тестовый пользователь создан или уже существует",
  "user_id": 1,
  "login": "test_user"
}
```

**Ошибки**:
- 500: Ошибка при создании пользователя

#### 4. Получение типов постов
**URL**: `GET /system/post-types`

**Описание**: Возвращает список доступных типов постов.

**Ответ (200 OK)**:
```json
[
  {"id": 1, "name": "Пост"},
  {"id": 2, "name": "Комментарий"},
  {"id": 3, "name": "Репост"}
]
```

#### 5. Получение списка пользователей
**URL**: `GET /system/users`

**Описание**: Возвращает список пользователей.

**Ответ (200 OK)**:
```json
[
  {"id": 1, "login": "user1", "name": "Иван Иванов"},
  {"id": 2, "login": "user2", "name": "Петр Петров"}
]
```

## Эндпоинты для обработки изображений

Система поддерживает загрузку, хранение и обслуживание изображений. Изображения зашифрованы и безопасно хранятся в системе.

### Технические детали обработки изображений:

**Ограничения:**
- Максимальный размер файла: 10 МБ
- Поддерживаемые форматы: `.jpg`, `.jpeg`, `.png`, `.gif`, `.webp`

**Безопасность:**
- Имена файлов шифруются с использованием SHA-256 для предотвращения угадывания имен файлов
- Фреймворк проверяет тип файла перед сохранением
- Загружаемые файлы проверяются на вредоносный код

**Хранение и доступ:**
- Изображения хранятся в директории `uploads/images/`
- Доступ к изображениям через URL: `https://sber.levandrovskiy.ru/uploads/images/{filename}`
- URL-ы изображений хранятся в базе данных как `media_link`

## Модели данных API

### Пост (Post)
```json
{
  "post_id": 123,
  "content": "Текст поста",
  "child_id": null,
  "media_link": "/uploads/images/post_20230726172512_a1b2c3d4e5f6.jpg",
  "post_type_id": 1,
  "user_id": 1,
  "creation_date": "2023-07-26T17:25:12",
  "views_count": 0
}
```

### Детальная информация о посте (PostDetail)
```json
{
  "post_id": 123,
  "content": "Текст поста",
  "child_id": null,
  "media_link": "/uploads/images/post_20230726172512_a1b2c3d4e5f6.jpg",
  "post_type_id": 1,
  "user_id": 1,
  "creation_date": "2023-07-26T17:25:12",
  "views_count": 1,
  "likes_count": 5,
  "tags": [
    {"tag_id": 1, "name": "python", "tag_type_id": 1},
    {"tag_id": 2, "name": "fastapi", "tag_type_id": 1}
  ],
  "comments": [
    {
      "post_id": 124,
      "content": "Отличный пост!",
      "child_id": 123,
      "media_link": null,
      "post_type_id": 2,
      "user_id": 2,
      "creation_date": "2023-07-26T18:00:00",
      "views_count": 0,
      "replies": []
    }
  ]
}
```

### Комментарий (Comment)
```json
{
  "post_id": 124,
  "content": "Текст комментария",
  "child_id": 123,
  "media_link": null,
  "post_type_id": 2,
  "user_id": 1,
  "creation_date": "2023-07-26T18:00:00",
  "views_count": 0
}
```

### Комментарий с вложенными ответами (CommentWithReplies)
```json
{
  "post_id": 124,
  "content": "Текст комментария",
  "child_id": 123,
  "media_link": null,
  "post_type_id": 2,
  "user_id": 1,
  "creation_date": "2023-07-26T18:00:00",
  "views_count": 0,
  "replies": [
    {
      "post_id": 125,
      "content": "Ответ на комментарий",
      "child_id": 124,
      "media_link": null,
      "post_type_id": 2,
      "user_id": 3,
      "creation_date": "2023-07-26T19:00:00",
      "views_count": 0,
      "replies": []
    }
  ]
}
```

### Лайк (Like)
```json
{
  "like_id": 42,
  "post_id": 123,
  "user_id": 1
}
```

### Тег (Tag)
```json
{
  "tag_id": 1,
  "name": "python",
  "tag_type_id": 1
}
```

### Пользователь (UserDetail)
```json
{
  "user_id": 1,
  "login": "user123",
  "name": "Иван Иванов",
  "type_id": 1,
  "image_link": "/uploads/images/user_profile.jpg",
  "description": "Описание профиля пользователя",
  "rating": 4.8,
  "tags": [
    {"tag_id": 1, "name": "python", "tag_type_id": 1},
    {"tag_id": 2, "name": "fastapi", "tag_type_id": 1}
  ],
  "post_count": 15,
  "likes_count": 42
}
```

## Коды ошибок API

API возвращает следующие стандартные HTTP коды ошибок:

- **400 Bad Request** - Некорректный запрос или данные
- **404 Not Found** - Запрашиваемый ресурс не найден
- **422 Unprocessable Entity** - Ошибка валидации данных
- **500 Internal Server Error** - Внутренняя ошибка сервера

Формат ответа с ошибкой:
```json
{
  "detail": "Описание ошибки"
}
```

## Важные изменения в API

### Обновление 1.1.0
- Добавлена возможность отправки пустого значения для `child_id` при создании поста
- Улучшена обработка изображений с поддержкой большего числа форматов
- Добавлена проверка размера загружаемых файлов

### Обновление 1.0.0
- Первый релиз API с основными функциями для работы с постами, комментариями и лайками
- Реализована система тегов и рекомендаций
- Добавлена поддержка загрузки изображений

## Дополнительная информация

### Типы постов
- **1** - обычный пост
- **2** - комментарий
- **3** - репост

### Типы тегов
- **1** - обычный тег
- **2** - учебный тег
- **3** - системный тег

### Типы профилей пользователей
- **1** - студент
- **2** - преподаватель
- **3** - администратор

### Развертывание и запуск
API развернуто с использованием Docker и Caddy для обратного прокси и HTTPS:
- База данных: PostgreSQL
- API: FastAPI (Python)
- Обратный прокси: Caddy
``` 
</rewritten_file>